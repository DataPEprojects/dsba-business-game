<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="/static/style.css">
    <title>Market Strategy</title>
    <style>
        .market-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            background: #fff;
            height: 38px;
            cursor: pointer;
        }
        .market-input:focus {
            border-color: #3498db;
            outline: none;
        }
        .product-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .product-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            margin: -20px -20px 20px -20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .product-info {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .info-badge {
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: 600;
        }
        .stock-badge {
            background: #ebf5fb;
            color: #3498db;
        }
        .selection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85em;
            color: #7f8c8d;
            font-weight: 600;
            text-transform: uppercase;
        }
        .demand-info {
            margin-top: 15px;
            padding: 12px;
            background: #fef5e7;
            border-left: 4px solid #f39c12;
            border-radius: 4px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Market Sim</h2>
        <a href="/factories" class="menu-item">
             Factories <span style="float:right; background:#34495e; padding:2px 6px; border-radius:4px; font-size:0.8em;">{{ factory_count }}</span>
        </a>
        <a href="/production" class="menu-item"> Production</a>
        <a href="/market" class="menu-item active"> Sales Market</a>
        <a href="/overview" class="menu-item"> Overview & End Turn</a>
        
        <div style="margin-top:auto; padding-top:20px; border-top:1px solid #34495e;">
            <p style="font-size:0.9em; color:#bdc3c7;">Cash Available:</p>
            <h3 style="color:#2ecc71;">${{ player_cash }}</h3>
            <p style="font-size:0.8em; color:#7f8c8d; margin-top:5px;">Turn {{ current_turn }}</p>
        </div>
    </div>

    <div class="main-content">
        
        <div style="margin-bottom: 30px;">
            <h1>Sales Strategy - By Product</h1>
            <div style="background-color: #d4e6f1; color: #2980b9; padding: 15px; border-radius: 5px; margin-top: 15px; border-left: 5px solid #3498db;">
                <strong>📊 Global Event:</strong> {{ global_event.event }}
            </div>
        </div>

        <div style="max-width: 900px;">
            
            {% for product, meta in products_meta.items() %}
            {% set saved_country = player.sales_decisions.get(product, {}).get('country', '') %}
            {% set saved_price = player.sales_decisions.get(product, {}).get('price', 0) %}
            {% set allowed_prices = meta.get('price_options') or meta.get('price_range') or [] %}
            
            <div class="product-card">
                <div class="product-header">
                    <h2 style="margin: 0;">Product {{ product }}</h2>
                    <span style="font-size: 1.2em;">📦</span>
                </div>

                <div class="product-info">
                    <div class="info-badge stock-badge">
                        📊 Stock remaining from previous rounds: {{ player.stock.get(product, 0) }} units
                    </div>
                </div>

                <div class="selection-grid">
                    <!-- Sélection du pays -->
                    <div>
                        <label>🌍 Target Country</label>
                        <select class="market-input"
                                data-product="{{ product }}" 
                                data-field="country"
                                onchange="saveMarketData(this)">
                            <option value="" {% if saved_country == '' %}selected{% endif %}>-- Not Selling --</option>
                            {% for country in all_markets %}
                                <option value="{{ country }}" {% if saved_country == country %}selected{% endif %}>{{ country }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Sélection du prix -->
                    <div>
                        <label>💰 Selling Price</label>
                        <select class="market-input"
                                data-product="{{ product }}" 
                                data-field="price"
                                onchange="saveMarketData(this)">
                            <option value="0" {% if saved_price == 0 %}selected{% endif %}>-- No Price Set --</option>
                            {% for p in allowed_prices %}
                                <option value="{{ p }}" {% if saved_price == p %}selected{% endif %}>{{ p }} €</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Market demand information by country -->
                <div class="demand-info">
                    <strong>📈 Market Demand by Country:</strong><br>
                    {% for country in all_markets %}
                        <span style="display: inline-block; margin-right: 15px; margin-top: 5px;">
                            <strong>{{ country }}:</strong> {{ countries_data[country]["products"].get(product, {}).get("base_demand", 0) }} units
                        </span>
                    {% endfor %}
                </div>

            </div>
            {% endfor %}

        </div>
    </div>

    <script>
        function saveMarketData(input) {
            input.style.borderColor = "#f1c40f"; 

            let val = input.value;
            // If price field, convert to int, otherwise keep as string (country)
            if (input.dataset.field === 'price') {
                val = parseInt(val);
            }

            fetch('/update_sales_ajax', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    product: input.dataset.product,
                    field: input.dataset.field,
                    value: val
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'saved') {
                    input.style.borderColor = "#27ae60"; 
                    setTimeout(() => { input.style.borderColor = "#bdc3c7"; }, 800);
                } else {
                    input.style.borderColor = "#e74c3c";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                input.style.borderColor = "#e74c3c";
            });
        }
    </script>

</body>
</html>
