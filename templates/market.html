<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="/static/style.css">
    <title>Market Strategy</title>
    <style>
        .market-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            background: #fff;
            height: 38px;
            cursor: pointer;
        }
        .market-input:focus {
            border-color: #3498db;
            outline: none;
        }
        .product-box {
            background: #fdfdfd; 
            border: 1px solid #ecf0f1; 
            padding: 10px; 
            border-radius: 5px; 
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 3px;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Market Sim</h2>
        <a href="/factories" class="menu-item">
             Factories <span style="float:right; background:#34495e; padding:2px 6px; border-radius:4px; font-size:0.8em;">{{ factory_count }}</span>
        </a>
        <a href="/production" class="menu-item"> Production</a>
        <a href="/market" class="menu-item active"> Sales Market</a>
        <a href="/overview" class="menu-item"> Overview & End Turn</a>
        
        <div style="margin-top:auto; padding-top:20px; border-top:1px solid #34495e;">
            <p style="font-size:0.9em; color:#bdc3c7;">Cash Available:</p>
            <h3 style="color:#2ecc71;">${{ player_cash }}</h3>
            <p style="font-size:0.8em; color:#7f8c8d; margin-top:5px;">Turn {{ current_turn }}</p>
        </div>
    </div>

    <div class="main-content">
        
        <div style="margin-bottom: 30px;">
            <h1>Global Sales Strategy</h1>
            <div style="background-color: #d4e6f1; color: #2980b9; padding: 15px; border-radius: 5px; margin-top: 15px; border-left: 5px solid #3498db;">
                <strong> Global Event:</strong> {{ global_event.event }}
            </div>
        </div>

        <div class="factories-grid">
            
            {% for market_country in all_markets %}
            <div class="factory-card">
                
                <div class="card-header">
                    <h2>{{ market_country }}</h2>
                    <span class="stats">Target Market</span>
                </div>

                <div style="flex: 1;">
                    {% for product, meta in products_meta.items() %}
                    
                    {% set saved_price = player.sales_decisions.get(market_country, {}).get(product, {}).get('price', 0) %}
                    {% set allowed_prices = meta.get('price_options') or meta.get('price_range') or [] %}
                    {% set base_demand = countries_data[market_country]["products"].get(product, {}).get("base_demand", 0) %}

                    <div class="product-box">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <b style="color:#2c3e50;">Product {{ product }}</b>
                            <div style="display:flex; gap:10px;">
                                <span style="font-size:0.85em; color:#3498db; background:#ebf5fb; padding:3px 8px; border-radius:3px;">
                                     Stock: {{ player.stock.get(product, 0) }}
                                </span>
                                <span style="font-size:0.85em; color:#e67e22; background:#fef5e7; padding:3px 8px; border-radius:3px;">
                                     Max Demand: {{ base_demand }}
                                </span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 10px;">
                            <label style="font-size:0.75em; color:#7f8c8d; font-weight:600;">SELLING PRICE</label>
                            <select class="market-input"
                                    data-country="{{ market_country }}" 
                                    data-product="{{ product }}" 
                                    data-field="price"
                                    onchange="saveMarketData(this)">
                                
                                <option value="0" disabled {% if saved_price == 0 %}selected{% endif %}>-- Not Selling --</option>
                                {% for p in allowed_prices %}
                                    <option value="{{ p }}" {% if saved_price == p %}selected{% endif %}>{{ p }} €</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endfor %}
                </div>

            </div>
            {% endfor %}

        </div>
    </div>

    <script>
        function saveMarketData(input) {
            input.style.borderColor = "#f1c40f"; 

            let val = parseInt(input.value); 

            fetch('/update_sales_ajax', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    country: input.dataset.country,
                    product: input.dataset.product,
                    field: input.dataset.field,
                    value: val
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'saved') {
                    input.style.borderColor = "#27ae60"; 
                    setTimeout(() => { input.style.borderColor = "#bdc3c7"; }, 800);
                } else {
                    input.style.borderColor = "#e74c3c";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                input.style.borderColor = "#e74c3c";
            });
        }
    </script>

</body>
</html>
